---
title: Architecture Overview
category: architecture
date: 2025-12-21
status: active
---

# Architecture Overview

## Overview

The MCP Web3 Wallet Tester is a programmable Ethereum wallet designed for automated dApp testing. It bridges the gap between browser-based Web3 applications and test automation tools.

## System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Browser (Playwright)                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  dApp (e.g., Uniswap, OpenSea)                            │  │
│  │  ↓                                                         │  │
│  │  Injected Provider (provider.js)                          │  │
│  │  - Implements EIP-1193 (window.ethereum)                  │  │
│  │  - Announces via EIP-6963                                 │  │
│  │  - Connects via WebSocket                                 │  │
│  └───────────────────┬───────────────────────────────────────┘  │
└───────────────────────┼──────────────────────────────────────────┘
                        │ WebSocket (ws://localhost:8546)
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│               MCP Wallet Server (Node.js)                        │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              HTTP MCP Server (:3000)                     │    │
│  │  - Exposes MCP tools for wallet control                 │    │
│  │  - Serves provider.js at /provider.js                   │    │
│  │  - Provides LLM instructions as resources               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            │                                     │
│                    ┌───────┴───────┐                            │
│                    │ Request Queue │                            │
│                    │  (in-memory)  │                            │
│                    └───────┬───────┘                            │
│                            │                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │            WebSocket Bridge (:8546)                      │    │
│  │  - Receives requests from browser provider              │    │
│  │  - Queues requests for LLM approval                     │    │
│  │  - Returns results to browser                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            │                                     │
│                    ┌───────┴───────┐                            │
│                    │  Viem Wallet  │                            │
│                    │  (signing)    │                            │
│                    └───────┬───────┘                            │
└────────────────────────────│────────────────────────────────────┘
                             │ JSON-RPC
                             ▼
                    ┌─────────────────┐
                    │     Anvil       │
                    │   (:8545)       │
                    │  Local Testnet  │
                    └─────────────────┘
```

## Components

### 1. Injectable Provider (`provider.js`)

**Purpose:** Implements the Ethereum provider interface in the browser.

**Technology:** TypeScript, compiled to browser-compatible IIFE.

**Key Features:**
- EIP-1193 compliant (`window.ethereum`)
- EIP-6963 wallet discovery
- WebSocket communication to server
- Auto-reconnection on disconnect
- Subscription support (`eth_subscribe`)

**Interactions:**
- dApps call methods on `window.ethereum`
- Provider forwards requests via WebSocket
- Waits for server approval before returning

### 2. WebSocket Bridge

**Purpose:** Bidirectional communication between browser and server.

**Technology:** `ws` library (Node.js WebSocket server).

**Key Features:**
- Handles multiple concurrent browser connections
- Routes requests to the queue
- Returns approval results to browser
- Broadcasts UI notifications

### 3. Request Queue

**Purpose:** Manages pending wallet requests awaiting LLM approval.

**Technology:** In-memory queue with Promise-based resolution.

**Key Features:**
- Unique request IDs (`req_` prefix)
- Timeout handling
- Auto-approve mode
- Request history

### 4. MCP Server

**Purpose:** Exposes wallet control tools to LLMs via MCP protocol.

**Technology:** `@modelcontextprotocol/sdk`, Express.js.

**Key Features:**
- HTTP transport (stateless)
- Tools for approval/rejection
- Documentation as resources
- Provider script endpoint

### 5. Viem Wallet

**Purpose:** Handles actual Ethereum operations.

**Technology:** Viem library.

**Key Features:**
- Transaction signing
- Message signing (personal_sign, EIP-712)
- Multiple account support
- Nonce management

## Data Flow

### Wallet Connection Flow

```
1. User clicks "Connect Wallet" in dApp
2. dApp calls window.ethereum.request({ method: 'eth_requestAccounts' })
3. Provider sends request via WebSocket to server
4. Server adds request to queue
5. LLM calls wallet_getPendingRequests via MCP
6. LLM calls wallet_approveRequest with request ID
7. Server resolves request, returns wallet address
8. Provider receives result, returns to dApp
9. dApp shows "Connected"
```

### Transaction Flow

```
1. User initiates transaction in dApp
2. dApp calls eth_sendTransaction
3. Provider queues request on server
4. LLM reviews and approves via MCP
5. Server signs transaction with Viem
6. Transaction sent to Anvil
7. Transaction hash returned to dApp
8. LLM can verify with wallet_getTransactionReceipt
```

## Configuration

| Component | Port | Environment Variable |
|-----------|------|---------------------|
| MCP Server | 3000 | `MCP_PORT` |
| WebSocket | 8546 | `WS_PORT` |
| Anvil RPC | 8545 | `ANVIL_RPC_URL` |

## Trade-offs

### Pros
- Full control over wallet behavior
- Works with any dApp
- No browser extension required
- LLM can inspect transaction details

### Cons
- Requires running server
- WebSocket timing can be tricky
- Must inject provider before page loads

## Future Considerations

- Support for additional chains
- Persistent request history
- Transaction simulation
- Gas estimation overrides

## Related Documents

- [Provider Injection Guide](../guides/provider-injection-2025-12-21.md)
- [LLM Instructions](../LLM_INSTRUCTIONS.md)
- [Testing Guide](../TESTING_GUIDE.md)
